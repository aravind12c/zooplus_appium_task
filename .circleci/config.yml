version: 2.1
jobs:
    build:
        working_directory: ~/zooplus_appium_task
        docker:
            - image: circleci/openjdk:8-jdk
        steps:
            - checkout
            - run: mvn clean install -DskipTests=true
    regression-test:
        working_directory: ~/zooplus_appium_task
        docker:
            - image: circleci/android:api-29
        steps:
            - checkout
            - run:
                name: List Images
                command: sdkmanager --list --verbose | grep system-images
            android-test:
                    executor:
                    name: android/android-machine
                    resource-class: xlarge
    
            - android/start-emulator-and-run-tests:
                test-command: ./gradlew connectedDebugAndroidTest
                system-image: system-images;android-30;google_apis;x86

                name: Install Node
                command: |
                    cd
                    curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -
                    sudo apt install nodejs
            - run:
                name: Print Node and NPM Version
                command: |
                    node --version
                    npm --version
            - run:
                name: Install Appium
                command: |
                    cd
                    npm install appium@1.22.0
            - run:
                name: Start Appium
                command: cd ; appium
                background: true
            - run:
                name: Wait Until Appium Boot
                command: sleep 30
            - checkout
            
            - run:
                name: Run Tests
                command: mvn clean test -Dtest.level=regression -Dgroups=regression
            - store_test_results:
                path: target/surefire-reports
            - store_artifacts:
                path: target/surefire-reports
                destination: regression-test-results
workflows:
    build_and_test:
        jobs:
            - build
            - regression-test:
                        requires:
                            - build
